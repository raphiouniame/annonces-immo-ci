<!-- templates/listings/add_listing.html -->
{% extends "base.html" %}

{% block title %}Publier une annonce - ImmoFacile{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Publier une nouvelle annonce</h4>
            </div>
            <div class="card-body">
                <form method="POST" novalidate>
                    {{ form.hidden_tag() }}

                    <!-- Titre -->
                    <div class="mb-3">
                        {{ form.title.label(class="form-label fw-bold") }}
                        {{ form.title(class="form-control", placeholder="Ex: Appartement 3 pièces à Dakar") }}
                        {% if form.title.errors %}
                            <ul class="list-unstyled text-danger mt-1">
                                {% for error in form.title.errors %}
                                    <li><small>{{ error }}</small></li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        {{ form.description.label(class="form-label fw-bold") }}
                        {{ form.description(class="form-control", rows="5", placeholder="Décrivez le bien, ses équipements, sa localisation...") }}
                        {% if form.description.errors %}
                            <ul class="list-unstyled text-danger mt-1">
                                {% for error in form.description.errors %}
                                    <li><small>{{ error }}</small></li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <!-- Prix -->
                    <div class="mb-3">
                        {{ form.price.label(class="form-label fw-bold") }}
                        {{ form.price(class="form-control", placeholder="Ex: 500000") }}
                        {% if form.price.errors %}
                            <ul class="list-unstyled text-danger mt-1">
                                {% for error in form.price.errors %}
                                    <li><small>{{ error }}</small></li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <!-- Type d'annonce -->
                    <div class="mb-3">
                        {{ form.property_type.label(class="form-label fw-bold") }}
                        {{ form.property_type(class="form-select") }}
                        {% if form.property_type.errors %}
                            <ul class="list-unstyled text-danger mt-1">
                                {% for error in form.property_type.errors %}
                                    <li><small>{{ error }}</small></li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <!-- Upload Image -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Image principale <span class="text-danger">*</span></label>
                        <div id="upload_widget" class="btn btn-upload w-100 mb-2">
                            <i class="bi bi-cloud-arrow-up me-2"></i>Cliquer pour uploader une image
                        </div>
                        <small class="text-muted d-block mb-2">L'image sera ajoutée automatiquement.</small>

                        <!-- Champs cachés remplis par Cloudinary -->
                        {{ form.image_url(type="hidden", id="image_url") }}
                        <input type="hidden" id="image_public_id" name="image_public_id">

                        <!-- Aperçu de l'image -->
                        <div id="preview-image" class="mt-3" style="display: none;">
                            <img id="preview-img" class="rounded border" style="max-height: 200px; object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeImage()">
                                <i class="bi bi-trash me-1"></i>Supprimer
                            </button>
                        </div>

                        {% if form.image_url.errors %}
                            <ul class="list-unstyled text-danger mt-2">
                                {% for error in form.image_url.errors %}
                                    <li><small>{{ error }}</small></li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>

                    <!-- Upload Vidéo (optionnel) -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Vidéo (optionnel)</label>
                        <div id="upload_widget_video" class="btn btn-outline-secondary w-100 mb-2">
                            <i class="bi bi-camera-video me-2"></i>Uploader une vidéo
                        </div>
                        <small class="text-muted d-block mb-2">Format MP4 recommandé.</small>

                        <!-- Champs cachés -->
                        {{ form.video_url(type="hidden", id="video_url") }}
                        <input type="hidden" id="video_public_id" name="video_public_id">

                        <!-- Aperçu de la vidéo -->
                        <div id="preview-video" class="mt-3" style="display: none;">
                            <video id="preview-vid" controls class="border rounded" style="max-height: 200px;">
                                <source src="" type="video/mp4">
                            </video>
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeVideo()">
                                <i class="bi bi-trash me-1"></i>Supprimer
                            </button>
                        </div>
                    </div>

                    <!-- Bouton de soumission -->
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-success btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Chargement du widget Cloudinary -->
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<script>
// Configuration Cloudinary
const CLOUDINARY_CLOUD_NAME = 'dbn8ees4r';  // ✅ Défini une fois, proprement
const UPLOAD_PRESET_IMAGE = 'immo_upload';
const UPLOAD_PRESET_VIDEO = 'immo_upload_video';

// Widget pour l'image
var myWidget = cloudinary.createUploadWidget({
    cloudName: CLOUDINARY_CLOUD_NAME,
    uploadPreset: UPLOAD_PRESET_IMAGE,
    sources: ['local', 'url', 'camera'],
    folder: 'immo_app/images',
    resource_type: 'image',
    multiple: false,
    maxFiles: 1,
    language: 'fr',
    text: {
        "fr": {
            "upload_button": "Choisir un fichier",
            "start_upload": "Uploader",
            "cancel": "Annuler"
        }
    }
}, function(error, result) {
    if (result && result.event === "success") {
        const info = result.info;
        document.getElementById('image_url').value = info.secure_url;
        document.getElementById('image_public_id').value = info.public_id;

        const preview = document.getElementById('preview-img');
        preview.src = info.secure_url;
        document.getElementById('preview-image').style.display = 'block';
    }
});

// Widget pour la vidéo
var videoWidget = cloudinary.createUploadWidget({
    cloudName: CLOUDINARY_CLOUD_NAME,
    uploadPreset: UPLOAD_PRESET_VIDEO,
    sources: ['local'],
    folder: 'immo_app/videos',
    resource_type: 'video',
    multiple: false,
    maxFiles: 1,
    language: 'fr',
    text: {
        "fr": {
            "upload_button": "Choisir une vidéo",
            "start_upload": "Uploader",
            "cancel": "Annuler"
        }
    }
}, function(error, result) {
    if (result && result.event === "success") {
        const info = result.info;
        document.getElementById('video_url').value = info.secure_url;
        document.getElementById('video_public_id').value = info.public_id;

        const previewSource = document.getElementById('preview-vid').querySelector('source');
        previewSource.src = info.secure_url;
        document.getElementById('preview-vid').load();
        document.getElementById('preview-video').style.display = 'block';
    }
});

// Ouvrir les widgets
document.getElementById("upload_widget").addEventListener("click", function() {
    myWidget.open();
});

document.getElementById("upload_widget_video").addEventListener("click", function() {
    videoWidget.open();
});

// Supprimer l'image
function removeImage() {
    document.getElementById('image_url').value = '';
    document.getElementById('image_public_id').value = '';
    document.getElementById('preview-image').style.display = 'none';
}

// Supprimer la vidéo
function removeVideo() {
    document.getElementById('video_url').value = '';
    document.getElementById('video_public_id').value = '';
    document.getElementById('preview-video').style.display = 'none';
}
</script>

{% endblock %}